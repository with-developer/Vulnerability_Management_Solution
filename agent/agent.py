import socket
import subprocess
import ssl

# 에이전트 설정
HOST = '0.0.0.0'
PORT = 13469

def execute_script():
    try:
        result = subprocess.check_output(['./Ubuntu_Script.sh'], stderr=subprocess.STDOUT, shell=True)
        return result.decode('utf-8')
    except subprocess.CalledProcessError as e:
        return e.output.decode('utf-8')

context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
context.load_cert_chain('cert.pem', 'key.pem')
while(True):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind((HOST, PORT))
        s.listen()

        print(f"[*] Listening on {HOST}:{PORT}")
        conn, addr = s.accept()
        with context.wrap_socket(conn, server_side=True) as secure_conn:
            print(f"[*] Connected by {addr}")
            while True:
                data = secure_conn.recv(1024)
                if not data:
                    break
                if data.decode('utf-8') == 'RUN':
                    response = execute_script()
                    secure_conn.sendall(response.encode('utf-8'))
                elif data.decode('utf-8') == 'CONNECT_TEST':
                    response = 'CONNECT_SUCCESSFUL'
                    secure_conn.sendall(response.encode('utf-8'))
