{% extends 'layout.html' %}
 
{% block content %}

<!--  ################### -->
<!--  Start first Section -->
<!--  ################### -->
<div class="overview shadow-sm p-3 mb-5 bg-body rounded" style="padding: 1rem;padding-top: 0;margin-top: 30px;">
    <div class="title" style="margin:0; padding: 15px 0 0 0;">
        <i class="uil uil-document-layout-right"></i>
        <span class="text">Policy Manager</span>
    </div>
    <hr>
    <div style="display:flex;">
        <!-- Search Div Start -->
        <div class="d-flex justify-content-center">
          <form class="row g-3">
              <div class="col-auto">
                <input class="form-control" type="text" placeholder="Search Policy" aria-label="default input example" style="width:53.3vw; border-radius: unset;margin-right:15px;background: #f9fbfd;">
              </div>
        </div>
  
        <div class="input-group mb-3" style="width: fit-content;">
          <select class="form-select" aria-label="Default select example" style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
            <option selected>Category</option>
            <option value="1">계정관리</option>
            <option value="2">파일 및 디렉토리 관리</option>
            <option value="3">서비스 관리</option>
            <option value="4">로그 관리</option>
          </select>
        </div>
        <div class="input-group mb-3" style="width: fit-content;">
          <select class="form-select" aria-label="Default select example" style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
            <option selected>Risk</option>
            <option value="1">상</option>
            <option value="2">중</option>
            <option value="3">하</option>
          </select>
        </div>
        
  
        
      </form>
      <!-- Search Div End -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap">
        <div class="btn-toolbar mb-2 mb-md-0">
          <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" style="border-radius: unset;">Add Policy</button>
            <!-- Button trigger modal -->
          </div>
        </div>
      </div>
    </div>
  
    <div>
        <table class="table table-sm">
            <thead>
                <tr>
                  <th scope="col" style="text-align:center; width:1px;">#</th>
                  <th scope="col" style="text-align:center; width:150px">Category</th>
                  <th scope="col">Name <span style="font-size:0.7rem; color: gray;">(Standard Description)</span></th>
                  <th scope="col" style="text-align:center; width:100px;">Risk</th>
                  <th scope="col" style="text-align:center; width:60px;">Action</th>
                </tr>
              </thead>
              {% set start_index = (current_page - 1) * 7 %}
              <tbody style="font-size:0.8rem;vertical-align: middle;">
                {% for policy in policies %}
                <tr style="border-bottom:hidden">
                  <th scope="row">{{ policy.policy_num }}</th>
                  <td style="text-align:center;">{{ policy.category }}</td>
                  <td>{{ policy.policy_name }}</td>
                  <td rowspan="2" style="border-color: lightgray; text-align:center;">
                    <div class="custom-select">
                      <div class="select">
                          <select class="risk-selection" data-policy-id="{{ policy.policy_num }}">
                              <option value="상" {% if policy.risk == "상" %}selected{% endif %}>상</option>
                              <option value="중" {% if policy.risk == "중" %}selected{% endif %}>중</option>
                              <option value="하" {% if policy.risk == "하" %}selected{% endif %}>하</option>
                          </select>
                      </div>
                  </div>
                  
                  </td>
                  <td rowspan="2" style="border-color: lightgray; text-align:center;">
                    <!-- Actions: you can customize as required -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: transparent; border: none;">
                            <i class="uil uil-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">View Source Code</a></li>
                            <li><a class="dropdown-item" href="#">Edit Source Code</a></li>
                        </ul>
                    </div>
                </td>
                </tr>
                <tr style="border-top: hidden;">
                  <td></td>
                  <td></td>
                  <td style="color: gray; font-size:0.7rem; padding-top:0;">{{ policy.standard }}</td>
                  <td></td>
                </tr>
                {% set start_index = start_index + 1 %}
                {% endfor %}
            </tbody>
        </table>
        <div style="font-size: 0.7rem;color: grey;">
            showing {{ start_entry }} to {{ end_entry }} of {{ total_policies }} entries
  
            <div class="pagination" style="position: inherit;">
                {% if current_page > 1 %}
                <a href="{{ url_for('policy_manager.dashboard', page=1) }}" title="first page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">First</a>
                <a href="{{ url_for('policy_manager.dashboard', page=current_page-1) }}" title="previous page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Prev</a>
                {% endif %}
  
                {% for page_num in range(1, total_pages+1) %}
                {% if page_num == current_page %}
                <a href="{{ url_for('policy_manager.dashboard', page=page_num) }}" class="page-active" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">{{ page_num }}</a>
                {% else %}
                <a href="{{ url_for('policy_manager.dashboard', page=page_num) }}" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">{{ page_num }}</a>
                {% endif %}
                {% endfor %}
  
                {% if current_page < total_pages %}
                <a href="{{ url_for('policy_manager.dashboard', page=current_page+1) }}" title="next page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Next</a>
                <a href="{{ url_for('policy_manager.dashboard', page=total_pages) }}" title="last page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Last</a>
                {% endif %}
            </div>
        </div>
        
    </div>
  </div>
  <!-- ############ -->
  <!-- Secction End -->
  <!-- ############ -->

  <!-- ########### -->
  <!-- Modal Start -->
  <!-- ########### -->

<!-- Modal Structure for View Source Code -->
<div class="modal fade" id="viewSourceCodeModal" tabindex="-1" aria-labelledby="viewSourceCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewSourceCodeModalLabel">Source Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body row">
        <!-- Left Panel for OS and File Selection -->
        <div class="col-md-3 border-end" style="width:23%">
          <div class="accordion" id="osAccordion" style="margin:0;">
              <!-- Tabs will be dynamically generated here -->
          </div>
      </div>
        
        <!-- Right Panel for Source Code Display -->
        <div class="col-md-9">
            <!-- Display OS Info, File Name, Policy Number -->
            <div class="mb-3">
                <strong>OS:</strong> <span id="osTypeDisplay"></span><br>
                <strong>File Name:</strong> <span id="fileNameDisplay"></span><br>
                <strong>Policy Number:</strong> <span id="policyNameDisplay"></span>
            </div>
            
            <!-- Display Source Code -->
            <pre style="font-size: 0.5rem;"><code class="bash" id="sourceCodeContent">Here will be the script content...</code></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ######### -->
<!-- Modal END -->
<!-- ######### -->
<script>
  $(document).ready(function() {
      $('.risk-selection').change(function() {
          var selectedValue = $(this).val();
          var policyId = $(this).data('policy-id');
  
          $.ajax({
              type: 'POST',
              url: '/api/change_risk',
              data: { 
                  risk: selectedValue,
                  policy_id: policyId
              },
              success: function(response) {
                  if (response.status === "success") {
                      location.reload(); // 페이지 새로고침
                  } else {
                      alert("Failed to update risk!");
                  }
              },
              error: function(error) {
                  alert("Error: " + error.responseText);
              }
          });
      });
  
      var currentPolicyNum = null;
      // View Source Code
      $('.dropdown-item').click(function(e) {
        e.preventDefault();
    
        if ($(this).text() === "View Source Code") {
            currentPolicyNum = $(this).closest('tr').find('th[scope="row"]').text();
            console.log("Policy Number on View Source Code Click:", currentPolicyNum);  // Debugging line
            $("#policyNameDisplay").text(currentPolicyNum);  // 여기서 정책 번호를 설정합니다.

  
              $.get("/api/get_script_filename", function(response) {
                  if (response.result === "fail") {
                      alert("Error: " + response.message);
                      return;
                  }
  
  
                  let osTabsContainer = $("#osAccordion");

                  let dataResponse = response.data;  // API 응답에서 'data' 항목을 가져옵니다.

                  for (let osType in dataResponse) {
                      let tab = `
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="heading${osType}">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${osType}" aria-expanded="false" aria-controls="collapse${osType}">
                                  ${osType}
                              </button>
                          </h2>
                          <div id="collapse${osType}" class="accordion-collapse collapse" aria-labelledby="heading${osType}" data-bs-parent="#osAccordion">
                              <div class="accordion-body">
                                  <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small" style="margin:0;">
                      `;

                      for (let file of dataResponse[osType]) {
                          tab += `<li><a href="#" class="link-dark rounded script-file">${file.name}</a></li>`;
                      }

                      tab += `</ul></div></div></div>`;
                      osTabsContainer.append(tab);
                  }


                
  
                  $('#viewSourceCodeModal').modal('show');
              });
          }
      });
  
      $(document).on('click', '.link-dark.rounded.script-file', function(e) {
        e.preventDefault();
    
        const osType = $(this).closest('.accordion-item').find('.accordion-button').text().trim(); // 수정된 부분
        const fileName = $(this).text();
        const policyNum = $('#policyNameDisplay').text();
    
        // os_type, 파일명, 항목명을 모달에 표시
        $("#osTypeDisplay").text(osType);
        $("#fileNameDisplay").text(fileName);
        $("#policyNameDisplay").text(policyNum);
    
        $.get("/api/get_script_content_policy_num", {
            os_type: osType,
            file_name: fileName,
            policy_num: policyNum
        }, function(response) {
            if (response.result === "success") {
                $("#sourceCodeContent").text(response.data);
                hljs.highlightBlock(document.getElementById('sourceCodeContent'));
            } else {
                alert("Error: " + response.message);
            }
        });
    });
  });
    
  </script>
  

{% endblock %}