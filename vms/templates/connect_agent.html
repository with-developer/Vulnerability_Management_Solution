<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Connect Agents</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal">Connect Agent</button>
        <!-- Button trigger modal -->

        <!-- Modal Page Start-->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Connect Agents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form >
                  <div class="mb-3">
                    <label for="recipient-name" class="col-form-label">Server Name(description)<br>Please provide a server name between 2 to 15 characters.</label>
                    <input type="text" class="form-control" id="server_name">
                  </div>
                  <div class="mb-3">
                    <label for="message-text" class="col-form-label">Server IP</label>
                    <input type="text" class="form-control" id="server_ip">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" id="connectButton" class="btn btn-primary">Connect</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal Page END -->  

        <!-- Modal Data Post Start -->
        <script>
          $(document).ready(function() {
              document.getElementById("connectButton").addEventListener("click", function(e) { // 'e'를 매개변수로 추가
                  e.preventDefault(); // Prevent the default form submit action
                  
                  var serverName = $('#server_name').val();
                  var serverIp = $('#server_ip').val();
      
                  $.ajax({
                      type: "POST",
                      url: "/admin/api/agent_connect",
                      data: {
                          server_name: serverName,
                          server_ip: serverIp
                      },
                      success: function (response) {
                          console.log(response)
                          if (response['result'] == 'success') {
                              alert(response['message'])
                              window.location.href = '/admin'
                          } else {
                              alert(response['message'])
                          }
                      },
                      error: function(error) {
                          // Handle error
                          alert("Error sending data.");
                      }
                  });
              });
          });
      </script>
      <!-- Modal Data Post End -->

      </div>
    </div>
  </div>

  <div>
      <table class="table table-hover table-sm">
          <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Server Name</th>
                <th scope="col">Distro</th>
                <th scope="col">OS</th>
                <th scope="col">IP</th>
                <th scope="col">Last Scan</th>
                <th scope="col"></th>
              </tr>
            </thead>
            {% set start_index = (current_page - 1) * 10 %}
            <tbody>
              {% for agent in agents %}
              <tr>
                <th scope="row">{{ loop.index + start_index }}</th>
                <td>{{ agent.server_name }}</td>
                <td>{{ agent.remote_id_like }}</td>
                <td>{{ agent.remote_id }}</td>
                <td>{{ agent.server_ip }}</td>
                <td>23.08.09</td>
                <td>
                  <button type="button" style="font-size: 0.5rem" class="btn btn-info btn-sm configButton" data-id="{{ agent._id }}">View Detail</button>
              </td>
              </tr>
              {% set start_index = start_index + 1 %}
              {% endfor %}
            </tbody>
      </table>
      <!-- Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="configModalLabel">Agent Configuration</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="configForm">
                <input type="hidden" id="currentAgentId">
                  <div class="mb-3">
                      <label for="configServerName" class="col-form-label">Server Name(description)<br>Please provide a server name between 2 to 15 characters.</label>
                      <input type="text" class="form-control" id="configServerName">
                  </div>
                  <div class="mb-3">
                    <label class="col-form-label">Server IP</label>
                    <input class="form-control" id="configServerIP" type="text" disabled>
                  </div>
                  <div class="mb-3">
                    <label for="configServerDistro" class="col-form-label">Distro</label>
                    <input type="text" class="form-control" id="configServerDistro">
                  </div>
                  <div class="mb-3">
                    <label for="configServerOS" class="col-form-label">OS</label>
                    <input type="text" class="form-control" id="configServerOS">
                  </div>
                  <div class="mb-3">
                    <label for="configServerVersion" class="col-form-label">Version</label>
                    <input type="text" class="form-control" id="configServerVersion">
                  </div>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" id="saveConfigButton" class="btn btn-primary">Save</button>
          </div>
      </div>
  </div>
</div>
<!-- Modal End -->
<!-- Ajax Start -->
<script>
  $(document).ready(function() {
    // Config button 클릭 이벤트
    $(".configButton").click(function(e) {
        e.preventDefault(); // 기본 동작을 막습니다.
        // 해당 버튼의 data-id 값을 가져옵니다.
        var agentId = $(this).attr("data-id");
        
        // AJAX를 사용하여 서버에서 agent의 정보를 가져옵니다.
        $.ajax({
            type: "GET",
            url: "/admin/api/agents_config",
            data: {
                agent_id: agentId
            },
            success: function(response) {
                // 가져온 정보를 모달의 입력 필드에 채웁니다.
                $("#currentAgentId").val(agentId);
                $('#configServerName').val(response.server_name);
                $('#configServerIP').val(response.server_ip);
                $('#configServerDistro').val(response.remote_id_like);
                $('#configServerOS').val(response.remote_id);
                $('#configServerVersion').val(response.remote_version);
                
                // 모달을 수동으로 띄웁니다.
                $('#configModal').modal('show');
            },
            error: function(error) {
              if (error.responseJSON && error.responseJSON.error) {
                  Swal.fire(error.responseJSON.error_code, error.responseJSON.error, 'error');
              } else {
                  Swal.fire('ERROR', "Error fetching agent data", 'error');
              }
          }
        });
    });
    $("#saveConfigButton").click(function(e) {
      e.preventDefault();

      var agentId = $("#currentAgentId").val();
      var serverName = $('#configServerName').val();
      var serverIp = $('#configServerIP').val();
      var serverDistro = $('#configServerDistro').val();
      var serverOS = $('#configServerOS').val();
      var serverVersion = $('#configServerVersion').val();

      $.ajax({
          type: "POST",
          url: "/admin/api/agents_config_save",
          data: {
              agent_id: agentId,
              server_name: serverName,
              server_ip: serverIp,
              remote_id_like: serverDistro,
              remote_id: serverOS,
              remote_version: serverVersion
          },
          success: function(response) {
              if (response['result'] == 'success') {
                  Swal.fire('SUCCESS', response['message'], 'success');
                  $('#configModal').modal('hide'); // 모달을 숨깁니다.
              } else {
                  Swal.fire('ERROR', response['message'], 'error');
              }
          },
          error: function(error) {
              Swal.fire('ERROR', "Error saving agent data.", 'error');
          }
      });
  });

});
</script>
<!-- Ajax End -->
  </div>
  <div class="d-flex justify-content-center">
      <form class="row g-3">
          <div class="col-auto">
            <input class="form-control" type="text" placeholder="Search Agent" aria-label="default input example">
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary mb-3">Search</button>
          </div>
        </form>
  </div>

  
  <nav aria-label="Page navigation" class="d-flex justify-content-center">
    <ul class="pagination">
      <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
        <a class="page-link" data-page="prev" href="#">Previous</a>
      </li>
      {% for i in range(1, total_pages + 1) %}
          <li class="page-item {% if i == current_page %}active{% endif %}">
              <a class="page-link" data-page="{{ i }}" href="#">{{ i }}</a>
          </li>
      {% endfor %}
      <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
        <a class="page-link" data-page="next" href="#">Next</a>
      </li>
    </ul>
  </nav>
  <script>
    $(document).ready(function() {
        function loadPage(pageNum) {
            $.ajax({
                url: '/admin/load_agents',
                type: 'GET',
                data: { page: pageNum },
                success: function(response) {
                    $('#agents').html(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }
  
        $('.page-link').on('click', function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            let currentPage = $('.pagination .active a').data('page');
            if (page === "prev") {
                if (currentPage > 1) {
                    currentPage--;
                }
            } else if (page === "next") {
                if (currentPage < {{ total_pages }}) {
                    currentPage++;
                }
            } else {
                currentPage = page;
            }
            loadPage(currentPage);
        });
    });
  </script>
  