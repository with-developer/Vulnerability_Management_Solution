<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h3 class="h3">Script Manager</h3>
</div>

<div>
    <table class="table table-hover table-sm">
        <thead>
            <tr>
                <th scope="col">OS</th>
                <th scope="col">Script Name</th>
                <th scope="col">Last Modified</th>
                <th scope="col">File Size</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for os_type, script_data in scripts.items() %}
            {% for script in script_data %}
                <tr>
                    {% if loop.first %}
                        <th scope="row" rowspan="{{ script_data|length }}">{{ os_type }}</th>
                    {% endif %}
                    <td>{{ script.name }}</td>
                    <td>{{ script.last_modified }}</td>
                    <td>{{ script.size }} bytes</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" style="font-size: 0.5rem" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Actions
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item view-script" href="#" data-os-type="{{ os_type }}" data-script-name="{{ script.name }}">View Script</a></li>
                                <li><a class="dropdown-item edit-script" href="#" data-os-type="{{ os_type }}" data-script-name="{{ script.name }}">Edit Script</a></li>
                                <li><a class="dropdown-item rename-script" href="#" data-os-type="{{ os_type }}" data-script-name="{{ script.name }}">Rename Script</a></li>
                                <li><a class="dropdown-item delete-script" href="#" data-os-type="{{ os_type }}" data-script-name="{{ script.name }}">Delete Script</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- View Script Modal Start -->
<div class="modal fade" id="scriptModal" tabindex="-1" aria-labelledby="scriptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 65%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptModalLabel">View Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre style="max-height:400px; overflow-y:auto;"><code id="scriptContent" class="bash"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- View Script Modal End -->

<!-- Edit Script Modal Start -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 65%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editor" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Edit Script Modal End -->

<!-- Rename Script Modal Start -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">Rename Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="newScriptName">New Script Name:</label>
                <input type="text" class="form-control" id="newScriptName">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="renameSaveButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Rename Script Modal End -->

<!-- View Script Ajax Start -->
<script>
    $(document).ready(function() {
        $(".view-script").click(function(e) {
            e.preventDefault();
            
            // Get file path from the `data-*` attributes
            var osType = $(this).data("os-type");
            var scriptName = $(this).data("script-name");

            // AJAX call to get script content
            $.ajax({
                type: "GET",
                url: "/admin/api/get_script",
                data: {
                    os_type: osType,
                    script_name: scriptName
                },
                success: function(response) {
                    // Insert script content into the modal and show it
                    $("#scriptContent").text(response);
                    hljs.highlightBlock(document.getElementById("scriptContent"));
                    $("#scriptModal").modal("show");
                    
                },
                error: function(error) {
                    alert("Error fetching script.");
                }
            });
        });
    });
</script>
<!-- View Script Ajax End -->

<!-- Edit Script Ajax Start -->
<script>
    $(document).ready(function() {
        let editor = ace.edit("editor");
        let selectedOsType = "";
        let selectedScriptName = "";
        editor.setTheme("ace/theme/pastel_on_dark");
        editor.session.setMode("ace/mode/sh");
        
        $(".edit-script").click(function(e) {
            e.preventDefault();
            
            selectedOsType = $(this).data("os-type");
            selectedScriptName = $(this).data("script-name");
        
            $.ajax({
                type: "GET",
                url: "/admin/api/get_script",
                data: {
                    os_type: selectedOsType,
                    script_name: selectedScriptName
                },
                success: function(response) {
                    editor.setValue(response, -1);
                    editor.setShowPrintMargin(false);
                    $("#editModal").modal("show");
                },
                error: function(error) {
                    alert("Error fetching script.");
                }
            });
        });

        $("#saveButton").click(function() {
            let editedContent = editor.getValue();
            
            // get selected script info
            var osType = selectedOsType;
            var scriptName = selectedScriptName;
            
            $.ajax({
                type: "POST",
                url: "/admin/api/save_script",
                data: {
                    os_type: osType,
                    script_name: scriptName,
                    content: editedContent
                },
                success: function(response) {
                    if(response.result === "success") {
                        $("#editModal").modal("hide");
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: response.message
                        }).then(function() {
                            // get_script reload
                            $("#script-tab").click();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: response.message
                        });
                    }
                },
                error: function(error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Error saving script.'
                    });
                }        
            });
        });
    });
</script>
<!-- Edit Script Ajax End -->

<!-- Rename Script Ajax Start -->
<script>
    $(document).ready(function() {
        let renameOsType = "";
        let renameScriptName = "";

        $(".rename-script").click(function(e) {
            e.preventDefault();
            
            // Get current script information from the `data-*` attributes
            renameOsType = $(this).data("os-type");
            renameScriptName = $(this).data("script-name");
            
            // Show the rename modal
            $("#newScriptName").val(renameScriptName); // Set current script name as default
            $("#renameModal").modal("show");
        });

        $("#renameSaveButton").click(function() {
            let newScriptName = $("#newScriptName").val();
            
            if(newScriptName.trim() === "") {
                alert("Script name cannot be empty.");
                return;
            }
            
            // AJAX request to rename the script
            $.ajax({
                type: "POST",
                url: "/admin/api/rename_script",
                data: {
                    os_type: renameOsType,
                    old_script_name: renameScriptName,
                    new_script_name: newScriptName
                },
                success: function(response) {
                    if(response.result === "success") {
                        $("#renameModal").modal("hide");
                        Swal.fire({
                            icon: 'success',
                            title: 'Renamed!',
                            text: response.message
                        }).then(function() {
                            $("#script-tab").click();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: response.message
                        });
                    }
                },
                error: function(error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Error renaming script.'
                    });
                }
            });
        });
    });
</script>
<!-- Rename Script Ajax End -->

<!-- Delete Script Ajax Start -->
<script>
    $(document).ready(function() {
        $(".delete-script").click(function(e) {
            e.preventDefault();
            
            // Get file path from the `data-*` attributes
            var osType = $(this).data("os-type");
            var scriptName = $(this).data("script-name");
            
            Swal.fire({
                title: 'Are you sure?',
                text: `Do you want to delete '${scriptName}'?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: "/admin/api/delete_script",
                        data: {
                            os_type: osType,
                            script_name: scriptName
                        },
                        success: function(response) {
                            if(response.result === "success") {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted!',
                                    text: response.message
                                }).then(function() {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: response.message
                                });
                            }
                        },
                        error: function(error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Error deleting script.'
                            });
                        }
                    });
                }
            });
        });
    });
</script>
<!-- Delete Script Ajax End -->
