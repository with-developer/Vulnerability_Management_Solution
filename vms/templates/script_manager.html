{% extends 'layout.html' %}

{% block content %}




<!--  ################### -->
<!--  Start first Section -->
<!--  ################### -->
<div class="overview shadow-sm p-3 mb-5 bg-body rounded" style="padding: 1rem;padding-top: 0;margin-top: 30px;">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="script-manager-tab" data-bs-toggle="tab" href="#script-manager"
                role="tab" aria-controls="script-manager" aria-selected="true">Script Manager</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="script-editor-tab" data-bs-toggle="tab" href="#script-editor" role="tab"
                aria-controls="script-editor" aria-selected="false">Script Editor</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="myTabContent">
        <!-- Script Manager Section -->
        <div class="tab-pane fade show active" id="script-manager" role="tabpanel" aria-labelledby="script-manager-tab">
            <!-- Your existing content for Script Manager here... -->
            <div class="title" style="margin:0; padding: 15px 0 0 0;">
                <i class="uil uil-document-layout-right"></i>
                <span class="text">Script Manager</span>
            </div>
            <hr>
            <div style="display:flex;">
                <!-- Search Div Start -->
                <div class="d-flex justify-content-center">
                    <form class="row g-3">
                        <div class="col-auto">
                            <input class="form-control" type="text" placeholder="Search Policy"
                                aria-label="default input example"
                                style="width:45.3vw; border-radius: unset;margin-right:15px;background: #f9fbfd;">
                        </div>
                </div>

                <div class="input-group mb-3" style="width: fit-content;">
                    <select class="form-select" aria-label="Default select example"
                        style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
                        <option selected>OS</option>
                        <option value="1">Debian</option>
                        <option value="2">Centos</option>
                        <option value="3">Fedora</option>
                        <option value="4">Rocky</option>
                    </select>
                </div>
                <div class="input-group mb-3" style="width: fit-content; margin-right:auto;">
                    <select class="form-select" aria-label="Default select example"
                        style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
                        <option selected>Script Name</option>
                        <option value="1">상</option>
                        <option value="2">중</option>
                        <option value="3">하</option>
                    </select>
                </div>



                </form>
                <!-- Search Div End -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap" style="margin-right:1rem;">
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal" style="border-radius: unset;">Import Script</button>
                            <!-- Button trigger modal -->
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap" sytle="margin-right:auto;">
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal" style="border-radius: unset;">Export Script</button>
                            <!-- Button trigger modal -->
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th scope="col" style="text-align: center;">OS</th>
                            <th scope="col" style="text-align: center;">Script Name</th>
                            <th scope="col" style="text-align: center;">Last Modified</span></th>
                            <th scope="col" style="text-align: center;">Modified By</th>
                            <th scope="col" style="text-align: center;">File Size</th>
                            <th scope="col" style="text-align: center;">File Hash</th>
                            <th scope="col" style="text-align:center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody style="font-size:0.8rem;vertical-align: middle;">
                        {% for os_type, script_data in scripts.items() %}
                        {% for script in script_data %}
                        <tr>
                            {% if loop.first %}
                            <th scope="row" rowspan="{{ script_data|length }}" style="text-align: center;">{{ os_type }}
                            </th>
                            {% endif %}
                            <td style="text-align: center;">{{ script.name }}</td>
                            <td style="text-align: center;">{{ script.last_modified }}</td>
                            <td style="text-align: center;">admin</td>
                            <td style="text-align: center;">{{ script.size }} bytes</td>
                            <td style="text-align: center;"> {{ script.md5 }}</td>
                            <td style="text-align:center;">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="dropdown"
                                        aria-expanded="false" style="background-color: transparent; border: none;">
                                        <i class="uil uil-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item view-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">View Script</a></li>
                                        <li><a class="dropdown-item edit-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Edit Script</a></li>
                                        <li><a class="dropdown-item rename-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Rename Script</a></li>
                                        <li><a class="dropdown-item delete-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Delete Script</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>


            </div>
            <!-- ############ -->
            <!-- Secction End -->
            <!-- ############ -->

        </div>

        <!-- Script Editor Section -->
        <div class="tab-pane fade" id="script-editor" role="tabpanel" aria-labelledby="script-editor-tab">
            <!--  #################### -->
            <!--  Start Second Section -->
            <!--  #################### -->
            <div class="title" style="margin:0; padding: 15px 0 0 0;">
                <i class="uil uil-document-layout-right"></i>
                <span class="text">Script Editor</span>
                <div style="display:flex; align-items: center; gap: 15px; padding: inherit;">
                    <!-- OS Type Select -->
                    <div class="input-group mb-3" style="width: fit-content; margin-left: 2rem;">
                        <select class="form-select form-select-sm" aria-label="OS Type">
                            <option selected>Select OS Type</option>
                            {% for os_type in scripts.keys() %}
                            <option value="{{ os_type }}">{{ os_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Script File Select -->
                    <div class="input-group mb-3" style="width: fit-content;">
                        <select class="form-select form-select-sm" aria-label="Script File">
                            <option selected>Select Script File</option>
                            {% for os_type, script_data in scripts.items() %}
                            {% for script in script_data %}
                            <option value="{{ script.name }}">{{ script.name }}</option>
                            {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Policy Name Select -->
                    <div class="input-group mb-3" style="width: fit-content;">
                        <select class="form-select form-select-sm" aria-label="Policy Name">
                            <option selected>Select Policy Name</option>
                            <option value="all">ALL</option>
                            {% for policy in policies %}
                            <option value="{{ policy.u_num }}">{{ policy.policy_num }}. {{ policy.policy_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
           
            <hr>
        
            <div>
                <div style="margin-top: 20px;">
                    <pre><code id="scriptContentEditable" class="bash" contenteditable="true" style="font-size:smaller;">123</code></pre>
                </div>
            </div>
            <!-- ################### -->
            <!-- Second Secction End -->
            <!-- ################### -->
        </div>
        
    </div>

</div>




<!-- View Script Modal Start -->
<div class="modal fade" id="scriptModal" tabindex="-1" aria-labelledby="scriptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 65%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptModalLabel">View Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre style="max-height:400px; overflow-y:auto;"><code id="scriptContent" class="bash"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- View Script Modal End -->

<!-- Edit Script Modal Start -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 65%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editor" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Edit Script Modal End -->

<!-- Rename Script Modal Start -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">Rename Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="newScriptName">New Script Name:</label>
                <input type="text" class="form-control" id="newScriptName">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="renameSaveButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Rename Script Modal End -->

<!-- View Script Ajax Start -->
<script>
    $(document).ready(function () {
        $(".view-script").click(function (e) {
            e.preventDefault();

            // Get file path from the `data-*` attributes
            var osType = $(this).data("os-type");
            var scriptName = $(this).data("script-name");

            // AJAX call to get script content
            $.ajax({
                type: "GET",
                url: "/api/get_script",
                data: {
                    os_type: osType,
                    script_name: scriptName
                },
                success: function (response) {
                    // Insert script content into the modal and show it
                    $("#scriptContent").text(response);
                    hljs.highlightBlock(document.getElementById("scriptContent"));
                    $("#scriptModal").modal("show");

                },
                error: function (error) {
                    alert("Error fetching script.");
                }
            });
        });
    });
</script>
<!-- View Script Ajax End -->

<!-- Edit Script Ajax Start -->
<script>
    $(document).ready(function () {
        let editor = ace.edit("editor");
        let selectedOsType = "";
        let selectedScriptName = "";
        editor.setTheme("ace/theme/pastel_on_dark");
        editor.session.setMode("ace/mode/sh");

        $(".edit-script").click(function (e) {
            e.preventDefault();

            selectedOsType = $(this).data("os-type");
            selectedScriptName = $(this).data("script-name");

            $.ajax({
                type: "GET",
                url: "/api/get_script",
                data: {
                    os_type: selectedOsType,
                    script_name: selectedScriptName
                },
                success: function (response) {
                    editor.setValue(response, -1);
                    editor.setShowPrintMargin(false);
                    $("#editModal").modal("show");
                },
                error: function (error) {
                    alert("Error fetching script.");
                }
            });
        });

        $("#saveButton").click(function () {
            let editedContent = editor.getValue();

            // get selected script info
            var osType = selectedOsType;
            var scriptName = selectedScriptName;

            $.ajax({
                type: "POST",
                url: "/api/save_script",
                data: {
                    os_type: osType,
                    script_name: scriptName,
                    content: editedContent
                },
                success: function (response) {
                    if (response.result === "success") {
                        $("#editModal").modal("hide");
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: response.message
                        }).then(function () {
                            // get_script reload
                            $("#script-tab").click();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: response.message
                        });
                    }
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Error saving script.'
                    });
                }
            });
        });
    });
</script>
<!-- Edit Script Ajax End -->

<!-- Rename Script Ajax Start -->
<script>
    $(document).ready(function () {
        let renameOsType = "";
        let renameScriptName = "";

        $(".rename-script").click(function (e) {
            e.preventDefault();

            // Get current script information from the `data-*` attributes
            renameOsType = $(this).data("os-type");
            renameScriptName = $(this).data("script-name");

            // Show the rename modal
            $("#newScriptName").val(renameScriptName); // Set current script name as default
            $("#renameModal").modal("show");
        });

        $("#renameSaveButton").click(function () {
            let newScriptName = $("#newScriptName").val();

            if (newScriptName.trim() === "") {
                alert("Script name cannot be empty.");
                return;
            }

            // AJAX request to rename the script
            $.ajax({
                type: "POST",
                url: "/api/rename_script",
                data: {
                    os_type: renameOsType,
                    old_script_name: renameScriptName,
                    new_script_name: newScriptName
                },
                success: function (response) {
                    if (response.result === "success") {
                        $("#renameModal").modal("hide");
                        Swal.fire({
                            icon: 'success',
                            title: 'Renamed!',
                            text: response.message
                        }).then(function () {
                            $("#script-tab").click();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: response.message
                        });
                    }
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Error renaming script.'
                    });
                }
            });
        });
    });
</script>
<!-- Rename Script Ajax End -->

<!-- Delete Script Ajax Start -->
<script>
    $(document).ready(function () {
        $(".delete-script").click(function (e) {
            e.preventDefault();

            // Get file path from the `data-*` attributes
            var osType = $(this).data("os-type");
            var scriptName = $(this).data("script-name");

            Swal.fire({
                title: 'Are you sure?',
                text: `Do you want to delete '${scriptName}'?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: "/api/delete_script",
                        data: {
                            os_type: osType,
                            script_name: scriptName
                        },
                        success: function (response) {
                            if (response.result === "success") {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted!',
                                    text: response.message
                                }).then(function () {
                                    $("#script-tab").click();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: response.message
                                });
                            }
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Error deleting script.'
                            });
                        }
                    });
                }
            });
        });
    });
</script>
<!-- Delete Script Ajax End -->

<!-- ############################### -->
<!-- Second Section Javascript Start -->
<!-- ############################### -->

<script>
    // Define a dictionary to hold the script files for each OS type
    const osScripts = {
        {% for os_type, script_data in scripts.items() %}
        "{{ os_type }}": [
            {% for script in script_data %}
            "{{ script.name }}",
            {% endfor %}
        ],
        {% endfor %}
    };

    // Update the script file select box when the OS type is changed
    document.querySelector('[aria-label="OS Type"]').addEventListener('change', function(e) {
        const selectedOSType = e.target.value;
        const scriptSelect = document.querySelector('[aria-label="Script File"]');
        
        // Clear the current options
        scriptSelect.innerHTML = '<option selected>Select Script File</option>';

        // Add the script files for the selected OS type
        if (osScripts[selectedOSType]) {
            osScripts[selectedOSType].forEach(scriptName => {
                const option = document.createElement('option');
                option.value = scriptName;
                option.textContent = scriptName;
                scriptSelect.appendChild(option);
            });
        }
    });

    const osTypeSelect = document.querySelector('[aria-label="OS Type"]');
    const scriptFileSelect = document.querySelector('[aria-label="Script File"]');
    const policyNameSelect = document.querySelector('[aria-label="Policy Name"]');

    function fetchScriptContent() {
        // Check if all three items are selected
        if (osTypeSelect.value !== "Select OS Type" && 
            scriptFileSelect.value !== "Select Script File" && 
            policyNameSelect.value !== "Select Policy Name") {
    
            const osType = osTypeSelect.value;
            const fileName = scriptFileSelect.value;
    
            // Extract policy_num from the selected option's text (e.g., "1.1. Some Policy Name")
            const policyText = policyNameSelect.options[policyNameSelect.selectedIndex].textContent;
            const policyNumMatch = policyText.match(/^(\d+\.\d+)/);
            const policyNum = policyNumMatch ? policyNumMatch[1] : null;
    
            $.ajax({
                type: "GET",
                url: "/api/get_script_content_policy_num",
                data: {
                    os_type: osType,
                    file_name: fileName,
                    policy_num: policyNum
                },
                success: function (response) {
                    if (response.result === "success") {
                        const codeBlock = document.getElementById('scriptContentEditable');
                        codeBlock.textContent = response.data;
                        hljs.highlightBlock(codeBlock);
                        hljs.lineNumbersBlock(codeBlock); // Add line numbers to the newly highlighted block
                    } else {
                        alert(response.message);
                    }
                },
                error: function (error) {
                    alert("Error fetching script content.");
                }
            });
        }
    }
    

    
    osTypeSelect.addEventListener('change', fetchScriptContent);
    scriptFileSelect.addEventListener('change', fetchScriptContent);
    policyNameSelect.addEventListener('change', fetchScriptContent);
    
    document.getElementById('scriptContentEditable').addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            
            var selection = window.getSelection();
            var range = selection.getRangeAt(0);
            
            var tabNode = document.createTextNode("\t");
            range.insertNode(tabNode);
            
            // Move the cursor
            range.setStartAfter(tabNode);
            range.setEndAfter(tabNode);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    });
    
        
    
</script>


<!-- ############################# -->
<!-- Second Section Javascript END -->
<!-- ############################# -->

{% endblock %}