{% extends 'layout.html' %}

{% block content %}
<!-- Style set -->
<style>
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-thumb {
        background: gainsboro;
    }
</style>
<!-- Style set end -->


<div class="overview shadow-sm p-3 mb-5 bg-body rounded"
    style="padding: 1rem;padding-top: 0;margin-top: 30px; margin-bottom:0 !important;">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="script-manager-tab" data-bs-toggle="tab" href="#script-manager"
                role="tab" aria-controls="script-manager" aria-selected="true">Script Manager</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="script-editor-tab" data-bs-toggle="tab" href="#script-editor" role="tab"
                aria-controls="script-editor" aria-selected="false">Script Editor</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">

        <!--  ################### -->
        <!--  Start first Section -->
        <!--  ################### -->
        <div class="tab-pane fade show active" id="script-manager" role="tabpanel" aria-labelledby="script-manager-tab">
            <div class="title" style="margin:0; padding: 15px 0 0 0;">
                <i class="uil uil-document-layout-right"></i>
                <span class="text">Script Manager</span>
            </div>
            <hr>
            <div style="display:flex;">
                <!-- Search Div Start -->
                <div class="d-flex justify-content-center">
                    <form class="row g-3">
                        <div class="col-auto">
                            <input class="form-control" type="text" placeholder="Search Policy"
                                aria-label="default input example"
                                style="width:45.3vw; border-radius: unset;margin-right:15px;background: #f9fbfd;">
                        </div>
                </div>

                <div class="input-group mb-3" style="width: fit-content;">
                    <select class="form-select" aria-label="Default select example"
                        style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
                        <option selected>OS</option>
                        <option value="1">Debian</option>
                        <option value="2">Centos</option>
                        <option value="3">Fedora</option>
                        <option value="4">Rocky</option>
                    </select>
                </div>
                <div class="input-group mb-3" style="width: fit-content; margin-right:auto;">
                    <select class="form-select" aria-label="Default select example"
                        style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
                        <option selected>Script Name</option>
                        <option value="1">상</option>
                        <option value="2">중</option>
                        <option value="3">하</option>
                    </select>
                </div>



                </form>
                <!-- Search Div End -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap" style="margin-right:1rem;">
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal" style="border-radius: unset;">Import Script</button>
                            <!-- Button trigger modal -->
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap" sytle="margin-right:auto;">
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal" style="border-radius: unset;">Export Script</button>
                            <!-- Button trigger modal -->
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th scope="col" style="text-align: center;">OS</th>
                            <th scope="col" style="text-align: center;">Script Name</th>
                            <th scope="col" style="text-align: center;">Last Modified</span></th>
                            <th scope="col" style="text-align: center;">Modified By</th>
                            <th scope="col" style="text-align: center;">File Size</th>
                            <th scope="col" style="text-align: center;">File Hash</th>
                            <th scope="col" style="text-align:center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody style="font-size:0.8rem;vertical-align: middle;">
                        {% for os_type, script_data in scripts.items() %}
                        {% for script in script_data %}
                        <tr>
                            {% if loop.first %}
                            <th scope="row" rowspan="{{ script_data|length }}" style="text-align: center;">{{ os_type }}
                            </th>
                            {% endif %}
                            <td style="text-align: center;">{{ script.name }}</td>
                            <td style="text-align: center;">{{ script.last_modified }}</td>
                            <td style="text-align: center;">admin</td>
                            <td style="text-align: center;">{{ script.size }} bytes</td>
                            <td style="text-align: center;"> {{ script.md5 }}</td>
                            <td style="text-align:center;">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="dropdown"
                                        aria-expanded="false" style="background-color: transparent; border: none;">
                                        <i class="uil uil-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item view-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">View Script</a></li>
                                        <li><a class="dropdown-item edit-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Edit Script</a></li>
                                        <li><a class="dropdown-item rename-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Rename Script</a></li>
                                        <li><a class="dropdown-item delete-script" href="#" data-os-type="{{ os_type }}"
                                                data-script-name="{{ script.name }}">Delete Script</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ############ -->
        <!-- Secction End -->
        <!-- ############ -->

        <!-- Script Editor Section -->
        <div class="tab-pane fade" id="script-editor" role="tabpanel" aria-labelledby="script-editor-tab">
            <!--  #################### -->
            <!--  Start Second Section -->
            <!--  #################### -->

            <!-- Editor Container -->
            <div class="editor-container shadow-lg" style="margin-top:1rem;">
                <!-- File Explorer -->
                <div class="file-explorer">
                    <div class="file-explorer-top" style="border-bottom: 1px solid #ddd;">
                        <i class="uil uil-document-layout-right"
                            style="position: relative;height: 35px;width: 35px;background-color: var(--primary-color);border-radius: 6px;color: var(--title-icon-color);display: inline-flex;align-items: center;justify-content: center;font-size: 24px;"></i>
                        <span class="text"
                            style="font-size: 24px;font-weight: 500;color: var(--text-color);margin-left: 10px;">Script
                            Editor</span>
                    </div>
                    <div class="accordion" id="fileAccordion">
                        <div
                            style="font-size: 0.7rem !important;padding-bottom: 0 !important;font-weight: bolder !important;padding-left: 0.4rem !important; padding-top: 10px !important;">
                            File Explorer</div>
                        <!-- Script files will be populated dynamically -->
                    </div>
                    <hr style="margin: 1rem 0 0;"> <!-- Divider between scripts and policies -->

                    <!-- Policies will be populated dynamically -->
                    <div class="accordion" id="policyContainer">
                        <div
                            style="font-size: 0.7rem !important;padding-bottom: 0 !important;font-weight: bolder !important;padding-left: 0.4rem !important; padding-top: 10px !important;">
                            Policy Explorer</div>
                        <a href="#" id="resetPolicyNum"
                            style="color: #555; text-decoration: none; font-size: 0.5rem !important; padding-left: 1.3rem;">All
                            policies</a>
                        {% set category_records = {} %}
                        {% for policy in policies %}
                        {% set category_records = category_records.setdefault(policy.category, []) %}
                        {% set _ = category_records.append(policy) %}
                        {% endfor %}

                        {% for category, policy_records in category_records.items() %}
                        <div>
                            <div>
                                <button class="btn btn-block text-left os-type-button policy-category-button"
                                    type="button" data-bs-toggle="collapse"
                                    data-bs-target="#{{ category|replace(' ', '_') }}">
                                    <i class="arrow-icon uil uil-angle-right"></i>
                                    <i class="uil uil-folder"></i>
                                    {{ category }}
                                </button>
                            </div>
                            <div class="collapse" id="{{ category|replace(' ', '_') }}">
                                <div class="card-body">
                                    <ul>
                                        {% for policy_record in policy_records %}
                                        <li>
                                            <!-- data-policy-num 속성을 추가하여 해당 정책의 policy_num 값을 저장 -->
                                            <a href="#" class="file-name-link"
                                                data-policy-num="{{ policy_record.policy_num }}">{{
                                                policy_record.policy_num }}. {{ policy_record.policy_name }}</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Main Editor Area -->
                <div class="editor-main">
                    <!-- Current File Name -->
                    <div style="background:#f5f5f5; display:flex; border-bottom: 1px solid #ddd;">
                        <div class="current-file-name" style="font-size:0.7rem; height:30px; padding:5px 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                                <path
                                    d="M9.25 12a.75.75 0 0 1-.22.53l-2.75 2.75a.75.75 0 0 1-1.06-1.06L7.44 12 5.22 9.78a.75.75 0 1 1 1.06-1.06l2.75 2.75c.141.14.22.331.22.53Zm2 2a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5Z">
                                </path>
                                <path
                                    d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0 1 22.25 21H1.75A1.75 1.75 0 0 1 0 19.25Zm1.75-.25a.25.25 0 0 0-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V4.75a.25.25 0 0 0-.25-.25Z">
                                </path>
                            </svg>
                            <span id="currentFileName">Select a file from the explorer</span>
                        </div>
                        <button id="save" class="save-button" style="margin-left:auto; border: 1px solid;">
                            <span>Save</span>
                        </button>
                        <button id="save-as" class="save-button" style="border: 1px solid;">
                            <span>Save as</span>
                        </button>
                    </div>
                    <div style="background:#ffffff; display:flex; border-bottom: none; height:18px;">
                        <div class="current-file-name" style="border-right: none; font-size:0.7rem; padding:0px 10px;">
                            <span id="currentPath">OS Type > File Name > Policy Category > Policy Name</span>
                        </div>
                    </div>
                    <div style="height: 100% !important;">
                        <!-- Monaco Editor Placeholder -->
                        <div id="monacoEditor" style="height:100% !important;"></div>
                    </div>
                </div>
            </div>
            <!-- ################### -->
            <!-- Second Secction End -->
            <!-- ################### -->
        </div>
    </div>
</div>

<!-- Rename Script Modal Start -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">Rename Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="newScriptName">New Script Name:</label>
                <input type="text" class="form-control" id="newScriptName">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="renameSaveButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Rename Script Modal End -->


<!-- Load script manager javascript -->
<script src="{{ url_for('static', filename='controller/script_controller.js') }}"></script>

{% endblock %}