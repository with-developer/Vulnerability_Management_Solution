{% extends 'layout.html' %}
 
{% block content %}

<!--  ################### -->
<!--  Start first Section -->
<!--  ################### -->
<div class="overview shadow-sm p-3 mb-5 bg-body rounded" style="padding: 1rem;padding-top: 0;margin-top: 30px;">
  <div class="title" style="margin:0; padding: 15px 0 0 0;">
      <i class="uil uil-servers"></i>
      <span class="text">Remote Manager</span>
  </div>
  <hr>
  <div style="display:flex;">
      <!-- Search Div Start -->
      <div class="d-flex justify-content-center">
        <form class="row g-3">
            <div class="col-auto">
              <input class="form-control" type="text" placeholder="Search Agent" aria-label="default input example" style="width:54.3vw; border-radius: unset;margin-right:15px;background: #f9fbfd;">
            </div>
      </div>

      <div class="input-group mb-3" style="width: fit-content;">
        <select class="form-select" aria-label="Default select example" style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
          <option selected>Groups</option>
          <option value="1">WEB</option>
          <option value="2">DBMS</option>
          <option value="3">WAS</option>
        </select>
      </div>
      <div class="input-group mb-3" style="width: fit-content;">
        <select class="form-select" aria-label="Default select example" style="border-radius: unset; padding: 0.70rem 1.8rem 0.6rem 0.75rem; font-size: 0.5rem;">
          <option selected>Status</option>
          <option value="1">Running</option>
          <option value="2">die</option>
        </select>
      </div>
      

      
    </form>
    <!-- Search Div End -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap">
      <div class="btn-toolbar mb-2 mb-md-0">
        <div>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" style="border-radius: unset;">Connect Agent</button>
          <!-- Button trigger modal -->
        </div>
      </div>
    </div>
  </div>

  <div>
      <table class="table table-hover table-sm" style="text-align:center">
          <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Server Name</th>
                <th scope="col">Score</th>
                <th scope="col">Group</th>
                <th scope="col">OS</th>
                <th scope="col">Version</th>
                <th scope="col">IP</th>
                <th scope="col">Saved Script</th>
                <th scope="col">Last Scan</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            {% set start_index = (current_page - 1) * 10 %}
            <tbody style="font-size:0.8rem;vertical-align: middle;">
              {% for agent in agents %}
              <tr>
                <th scope="row">{{ loop.index + start_index }}</th>
                <td>{{ agent.server_name }}</td>
                {% if agent.score|default("ERROR", true)|int(default=-1) >= 80 %}
                    <td><span class="badge bg-success" style="padding:0.7em 1em 0.5em 1em; font-size:0.8rem;">{{agent.score}}</span></td>
                {% elif 60 <= agent.score|default("ERROR", true)|int(default=-1) < 80 %}
                    <td><span class="badge bg-warning" style="padding:0.7em 1em 0.5em 1em; font-size:0.8rem;">{{agent.score}}</span></td>
                {% else %}
                    <td><span class="badge bg-danger" style="padding:0.7em 1em 0.5em 1em; font-size:0.8rem;">{{agent.score}}</span></td>
                {% endif %}
                <td>{{ agent.group }}</td>
                <td>{{ agent.remote_id }}</td>
                <td>{{ agent.remote_version }}</td>
                <td>{{ agent.server_ip }}</td>
                <td>{{ agent.saved_script_file }}</td>
                <td>23.08.09</td>
                <td style="border-color: lightgray; text-align:center;">
                  <!-- Actions: you can customize as required -->
                  <div class="btn-group">
                      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: transparent; border: none;">
                          <i class="uil uil-ellipsis-h"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                          <li><a class="dropdown-item configButton" href="#" data-id="{{ agent._id }}">View Detail</a></li>
                          <li><a class="dropdown-item send_script_button" href="#" data-id="{{ agent._id }}">Send Script</a></li>
                          <li><a class="dropdown-item run_script_button" href="#" data-id="{{ agent._id }}">Run Script</a></li>
                          <li><a class="dropdown-item disconnect_button" href="#" data-id="{{ agent._id }}">Disconnect Agent</a></li>
                      </ul>
                  </div>
              </td>
              </tr>
              {% set start_index = start_index + 1 %}
              {% endfor %}
            </tbody>
      </table>
      <div style="font-size: 0.7rem;color: grey;">
        showing {{ start_entry }} to {{ end_entry }} of {{ total_agents }} entries
    
        <div class="pagination" style="position: inherit;">
            {% if current_page > 1 %}
            <a href="{{ url_for('remote_manager.dashboard', page=1) }}" title="first page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">First</a>
            <a href="{{ url_for('remote_manager.dashboard', page=current_page-1) }}" title="previous page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Prev</a>
            {% endif %}
    
            {% for page_num in range(1, total_pages+1) %}
            {% if page_num == current_page %}
            <a href="{{ url_for('remote_manager.dashboard', page=page_num) }}" class="page-active" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">{{ page_num }}</a>
            {% else %}
            <a href="{{ url_for('remote_manager.dashboard', page=page_num) }}" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">{{ page_num }}</a>
            {% endif %}
            {% endfor %}
    
            {% if current_page < total_pages %}
            <a href="{{ url_for('remote_manager.dashboard', page=current_page+1) }}" title="next page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Next</a>
            <a href="{{ url_for('remote_manager.dashboard', page=total_pages) }}" title="last page" style="height: fit-content;padding-top: 0.3rem;padding-bottom: 0.3rem;">Last</a>
            {% endif %}
        </div>
    </div>
    
</div>
<!--  ################# -->
<!--  End First Section -->
<!--  ################# -->



<!--  ######################## -->
<!--  Start Modal&ajax Section -->
<!--  ######################## -->
<!-- Modal Page Start-->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Connect Agents</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form >
          <div class="mb-3">
            <label for="recipient-name" class="col-form-label">Server Name(description)<br>Please provide a server name between 2 to 15 characters.</label>
            <input type="text" class="form-control" id="server_name">
          </div>
          <div class="mb-3">
            <label for="message-text" class="col-form-label">Server IP</label>
            <input type="text" class="form-control" id="server_ip">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" id="connectButton" class="btn btn-primary">Connect</button>
      </div>
    </div>
    <!-- Loading... Spinner Start -->
    <div id="overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color: rgba(0, 0, 0, 0.5); z-index:1000;"></div>
    <div class="spinner-border text-primary" role="status" id="loadingSpinner" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2000;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <!-- Loading... Spinner End -->
  </div>
</div>
<!-- Modal Page END -->  

<!-- Modal Data Post Start -->
<script>
  $(document).ready(function() {
      document.getElementById("connectButton").addEventListener("click", function(e) { // 'e'를 매개변수로 추가
          e.preventDefault(); // Prevent the default form submit action
          
          var serverName = $('#server_name').val();
          var serverIp = $('#server_ip').val();
          $('#loadingSpinner').show();
          $('#overlay').show();

          $.ajax({
              type: "POST",
              url: "/api/agent_connect",
              data: {
                  server_name: serverName,
                  server_ip: serverIp
              },
              success: function (response) {
                  $("#loadingSpinner").hide();
                  $('#overlay').hide();
                  console.log(response)
                  if (response['result'] == 'success') {
                      Swal.fire('successfully', response['message'], 'success').then(function() {
                        location.reload();
                    });
                  } else {
                      Swal.fire('ERROR', response['message'], 'error');
                  }
              },
              error: function(error) {
                  // Handle error
                  $("#loadingSpinner").hide();
                  $('#overlay').hide();
                  Swal.fire('ERROR', "Error sending data.", 'error');
              }
          });
      });
  });
</script>
<!-- Modal Data Post End -->

<!-- View Agent Modal Start -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="configModalLabel">Agent Configuration</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="configForm">
                <input type="hidden" id="currentAgentId">
                  <div class="mb-3">
                      <label for="configServerName" class="col-form-label">Server Name(description)<br>Please provide a server name between 2 to 30 characters.</label>
                      <input type="text" class="form-control" id="configServerName">
                  </div>
                  <div class="mb-3">
                    <label class="col-form-label">Server IP</label>
                    <input class="form-control" id="configServerIP" type="text" disabled>
                  </div>
                  <div class="mb-3">
                    <label for="configServerDistro" class="col-form-label">Distro</label>
                    <input type="text" class="form-control" id="configServerDistro">
                  </div>
                  <div class="mb-3">
                    <label for="configServerOS" class="col-form-label">OS</label>
                    <input type="text" class="form-control" id="configServerOS">
                  </div>
                  <div class="mb-3">
                    <label for="configServerVersion" class="col-form-label">Version</label>
                    <input type="text" class="form-control" id="configServerVersion">
                  </div>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" id="saveConfigButton" class="btn btn-primary">Save</button>
          </div>
      </div>
  </div>
</div>
<!-- View Agent Modal End -->

<!-- View Agent Detail Ajax Start -->
<script>
  $(document).ready(function() {
    // Config button 클릭 이벤트
    $(".configButton").click(function(e) {
        e.preventDefault(); // 기본 동작을 막습니다.
        // 해당 버튼의 data-id 값을 가져옵니다.
        var agentId = $(this).attr("data-id");
        
        // AJAX를 사용하여 서버에서 agent의 정보를 가져옵니다.
        $.ajax({
            type: "GET",
            url: "/api/agents_config",
            data: {
                agent_id: agentId
            },
            success: function(response) {
                // 가져온 정보를 모달의 입력 필드에 채웁니다.
                $("#currentAgentId").val(agentId);
                $('#configServerName').val(response.server_name);
                $('#configServerIP').val(response.server_ip);
                $('#configServerDistro').val(response.remote_id_like);
                $('#configServerOS').val(response.remote_id);
                $('#configServerVersion').val(response.remote_version);
                
                // 모달을 수동으로 띄웁니다.
                $('#configModal').modal('show');
            },
            error: function(error) {
              if (error.responseJSON && error.responseJSON.error) {
                  Swal.fire(error.responseJSON.error_code, error.responseJSON.error, 'error');
              } else {
                  Swal.fire('ERROR', "Error fetching agent data", 'error');
              }
          }
        });
    });
    $("#saveConfigButton").click(function(e) {
      e.preventDefault();

      var agentId = $("#currentAgentId").val();
      var serverName = $('#configServerName').val();
      var serverIp = $('#configServerIP').val();
      var serverDistro = $('#configServerDistro').val();
      var serverOS = $('#configServerOS').val();
      var serverVersion = $('#configServerVersion').val();

      $.ajax({
          type: "POST",
          url: "/api/agents_config_save",
          data: {
              agent_id: agentId,
              server_name: serverName,
              server_ip: serverIp,
              remote_id_like: serverDistro,
              remote_id: serverOS,
              remote_version: serverVersion
          },
          success: function(response) {
              if (response['result'] == 'success') {
                  Swal.fire('SUCCESS', response['message'], 'success').then(function() {
                    location.reload();
                    $('#configModal').modal('hide'); // 모달을 숨깁니다.
                });
                  
              } else {
                  Swal.fire('ERROR', response['message'], 'error');
              }
          },
          error: function(error) {
              Swal.fire('ERROR', "Error saving agent data.", 'error');
          }
      });
  });

});
</script>
<!-- View Agent Detail Ajax End -->

<!-- Page navigator Start -->  
<!--
  <nav aria-label="Page navigation" class="d-flex justify-content-center">
    <ul class="pagination">
      <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
        <a class="page-link" data-page="prev" href="#">Previous</a>
      </li>
      {% for i in range(1, total_pages + 1) %}
          <li class="page-item {% if i == current_page %}active{% endif %}">
              <a class="page-link" data-page="{{ i }}" href="#">{{ i }}</a>
          </li>
      {% endfor %}
      <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
        <a class="page-link" data-page="next" href="#">Next</a>
      </li>
    </ul>
  </nav>
  -->
<!-- Page navigator End -->  

<!-- Page Navigator Ajax Start -->
  <script>
    $(document).ready(function() {
        function loadPage(pageNum) {
            $.ajax({
                url: '/admin/load_agents',
                type: 'GET',
                data: { page: pageNum },
                success: function(response) {
                    $('#agents').html(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }
  
        $('.page-link').on('click', function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            let currentPage = $('.pagination .active a').data('page');
            if (page === "prev") {
                if (currentPage > 1) {
                    currentPage--;
                }
            } else if (page === "next") {
                if (currentPage < {{ total_pages }}) {
                    currentPage++;
                }
            } else {
                currentPage = page;
            }
            loadPage(currentPage);
        });
    });
  </script>
<!-- Page Navigator Ajax End -->

<!-- Send Script Modal Start -->
<div class="modal fade" id="sendScriptModal" tabindex="-1" aria-labelledby="sendScriptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="sendScriptModalLabel">Send Script</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="sendScriptForm">
                  <div class="mb-3">
                      <label for="selectScript" class="col-form-label">Select a script:</label>
                      <select class="form-control custom-select" id="selectScript">
                      </select>
                  </div>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" id="sendScriptButton" class="btn btn-primary">Send</button>
          </div>
      </div>
  </div>
</div>
<!-- Send Script Modal End -->

<!-- Send Script Ajax Start -->
<script>
  $(document).ready(function() {
    
    let currentAgentId = null;

    // 각 에이전트의 'Send Script' 버튼을 클릭할 때의 이벤트 핸들러
    $(".send_script_button").click(function(e) {
        e.preventDefault();
        currentAgentId = $(this).data("id");

        // AJAX 호출로 사용 가능한 스크립트 이름들을 가져옵니다.
        $.ajax({
            type: "GET",
            url: "/api/get_script_names",
            success: function(response) {
                let options = '';
                response.forEach(script => {
                    options += `<option value="${script.name}" data-os="${script.os_type}">${script.name}</option>`;
                });
                $("#selectScript").html(options);

                // 모달을 표시합니다.
                $('#sendScriptModal').modal('show');
            },
            error: function(error) {
              Swal.fire('ERROR', "Error fetching script names.", 'error');
            }
        });
    });

    // 모달 내의 'Send' 버튼을 클릭할 때의 이벤트 핸들러
    $("#sendScriptButton").click(function(e) {
      e.preventDefault();

      let selectedScript = $("#selectScript").val();
      let osType = $("#selectScript option:selected").data("os");

      // 선택된 스크립트와 함께 /admin/api/send_script로 AJAX POST 요청을 보냅니다.
      $.ajax({
          type: "POST",
          url: "/api/send_script",
          data: {
              script_name: selectedScript,
              os_type: osType,
              agent_id: currentAgentId
          },
          success: function(response) {
              if(response.result === "success") {
                  Swal.fire(
                      'successfully',
                      "Script sent successfully!",
                      'success'
                  ).then(function() {
                    location.reload();
                    $('#sendScriptModal').modal('hide');
                });

              } else {
                  Swal.fire(
                    'Error!',
                    response.message || "Error sending script.",
                    'error'
                  );
              }
          },
          error: function(error) {
            Swal.fire(
                    'Error!',
                    response.message || "Error sending script.",
                    'error'
            );
          }
      });
    });
});
</script>
<!-- Send Script Ajax End -->

<!-- Run Script Ajax Start -->
<script>
  $(document).ready(function() {

      // Run Script 버튼 클릭 이벤트 핸들러
      $(".run_script_button").click(function(e) {
          e.preventDefault();
          const currentAgentId = $(this).data("id");

          // Swal을 사용해서 사용자에게 Script를 실행할 것인지 확인
          Swal.fire({
              title: 'Are you sure?',
              text: "Do you really want to run the script for this agent?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, run it!'
          }).then((result) => {
              if (result.isConfirmed) {
                  // 사용자가 확인을 클릭하면, AJAX 요청 시작
                  $.ajax({
                      type: "POST",
                      url: "/api/run_script",
                      data: {
                          agent_id: currentAgentId
                      },
                      success: function(response) {
                          if(response.result === "success") {
                              Swal.fire(
                                  'Executed!',
                                  'The script has been executed for the agent.',
                                  'success'
                              ).then(function() {
                                location.reload();
                            });
                          } else {
                              Swal.fire(
                                  'Error!',
                                  response.message || "Error executing script for agent.",
                                  'error'
                              );
                          }
                      },
                      error: function(error) {
                          Swal.fire(
                              'Error!',
                              "Error executing script for agent.",
                              'error'
                          );
                      }
                  });
              }
          });
      });

  });
</script>
<!-- Run Script Ajax End -->

<!-- Run Script Ajax End -->

<!-- Disconnect Agent Ajax Start -->
<script>
  $(document).ready(function() {
      
      let currentAgentId = null;
  
      // Disconnect Agent 버튼 클릭 이벤트 핸들러
      $(".disconnect_button").click(function(e) {
          e.preventDefault();
          currentAgentId = $(this).data("id");
  
          // Swal을 사용해서 사용자에게 Disconnect Agent를 할 것인지 확인
          Swal.fire({
              title: 'Are you sure?',
              text: "Do you really want to disconnect this agent?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, disconnect!'
          }).then((result) => {
              if (result.isConfirmed) {
                  // 사용자가 확인을 클릭하면, AJAX 요청 시작
                  $.ajax({
                      type: "POST",
                      url: "/api/disconnect_agent",
                      data: {
                          agent_id: currentAgentId
                      },
                      success: function(response) {
                          if(response.result === "success") {
                              Swal.fire(
                                  'Disconnected!',
                                  'The agent has been disconnected.',
                                  'success'
                              ).then(function() {
                                location.reload();
                            });
                          } else {
                              Swal.fire(
                                  'Error!',
                                  response.message || "Error disconnecting agent.",
                                  'error'
                              );
                          }
                      },
                      error: function(error) {
                          Swal.fire(
                              'Error!',
                              "Error disconnecting agent.",
                              'error'
                          );
                      }
                  });
              }
          });
      });
  
  
  });
  </script>
<!-- Disconnect Agent ajax End -->  
{% endblock %}