from flask import Blueprint, render_template, request, jsonify, current_app
from .api.check_auth import token_required
import os
from datetime import datetime

bp = Blueprint('script_manager', __name__, url_prefix='/script_manager')

@bp.route('/')
@token_required
def script_manager(current_user):
    base_path = "Vulnerability_Check_Script"
    os_types = ["CentOS", "Fedora", "Rocky", "Ubuntu"]

    scripts = {}

    for os_type in os_types:
        file_paths = [os.path.join(base_path, os_type, f) for f in os.listdir(os.path.join(base_path, os_type))]
        
        file_data = [{
            'name': os.path.basename(f), 
            'size': os.path.getsize(f),
            'last_modified': datetime.fromtimestamp(os.path.getmtime(f)).strftime('%Y-%m-%d %H:%M:%S')
        } for f in file_paths]

        # sort last_modify
        sorted_data = sorted(file_data, key=lambda x: x['last_modified'], reverse=True)
        scripts[os_type] = sorted_data

    return render_template('script_manager.html', scripts=scripts)