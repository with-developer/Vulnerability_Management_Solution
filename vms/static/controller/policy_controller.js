
$(document).ready(function () {
    $('.risk-selection').change(function () {
        var selectedValue = $(this).val();
        var policyId = $(this).data('policy-id');

        $.ajax({
            type: 'POST',
            url: '/api/change_risk',
            data: {
                risk: selectedValue,
                policy_id: policyId
            },
            success: function (response) {
                if (response.status === "success") {
                    location.reload(); // 페이지 새로고침
                } else {
                    alert("Failed to update risk!");
                }
            },
            error: function (error) {
                alert("Error: " + error.responseText);
            }
        });
    });

    var currentPolicyNum = null;
    // View Source Code
    $('.dropdown-item').click(function (e) {
        e.preventDefault();

        if ($(this).text() === "View Source Code") {
            currentPolicyNum = $(this).closest('tr').find('th[scope="row"]').text();
            console.log("Policy Number on View Source Code Click:", currentPolicyNum);  // Debugging line
            $("#policyNameDisplay").text(currentPolicyNum);  // 여기서 정책 번호를 설정합니다.


            $.get("/api/get_script_filename", function (response) {
                if (response.result === "fail") {
                    alert("Error: " + response.message);
                    return;
                }


                let osTabsContainer = $("#osAccordion");

                let dataResponse = response.data;  // API 응답에서 'data' 항목을 가져옵니다.

                for (let osType in dataResponse) {
                    let tab = `
                      <div class="accordion-item">
                          <h2 class="accordion-header" id="heading${osType}">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${osType}" aria-expanded="false" aria-controls="collapse${osType}">
                                  ${osType}
                              </button>
                          </h2>
                          <div id="collapse${osType}" class="accordion-collapse collapse" aria-labelledby="heading${osType}" data-bs-parent="#osAccordion">
                              <div class="accordion-body">
                                  <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small" style="margin:0;">
                      `;

                    for (let file of dataResponse[osType]) {
                        tab += `<li><a href="#" class="link-dark rounded script-file">${file.name}</a></li>`;
                    }

                    tab += `</ul></div></div></div>`;
                    osTabsContainer.append(tab);
                }




                $('#viewSourceCodeModal').modal('show');
            });
        }
    });

    $(document).on('click', '.link-dark.rounded.script-file', function (e) {
        e.preventDefault();

        const osType = $(this).closest('.accordion-item').find('.accordion-button').text().trim(); // 수정된 부분
        const fileName = $(this).text();
        const policyNum = $('#policyNameDisplay').text();

        // os_type, 파일명, 항목명을 모달에 표시
        $("#osTypeDisplay").text(osType);
        $("#fileNameDisplay").text(fileName);
        $("#policyNameDisplay").text(policyNum);

        $.get("/api/get_script_content_policy_num", {
            os_type: osType,
            file_name: fileName,
            policy_num: policyNum
        }, function (response) {
            if (response.result === "success") {
                $("#sourceCodeContent").text(response.data);
                hljs.highlightBlock(document.getElementById('sourceCodeContent'));
            } else {
                alert("Error: " + response.message);
            }
        });
    });
});
